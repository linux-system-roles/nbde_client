---
- hosts: all

  vars:
    nbde_client_test_device: /tmp/.nbde_client_dev_test
    nbde_client_test_pass: test-password-here
    nbde_client_test_keyfile: /tmp/.nbde_client_dev_keyfile

    nbde_client_bindings:
      - devices:
          - path: "{{ nbde_client_test_device }}"
            keyfile: "{{ nbde_client_test_keyfile }}"
        auth:
          servers:
            - public.nbde.cc
      - devices:
          - path: "{{ nbde_client_test_device }}"
            pass: "{{ nbde_client_test_keyfile }}"
        state: absent

  tasks:
    - name: Set up test device
      include: create_dummy_device.yml

    - name: Use nbde_client role
      include_role:
        name: linux-system-roles.nbde_client

    - name: Attempt to unlock device
      include: verify_unlock_device.yml

    - name: Make sure the attempt to unlock failed
      assert:
        that:
          - nbde_unlock.failed
          - nbde_close.failed

    - name: Clean up
      include: cleanup_dummy_device.yml
# vim:set ts=2 sw=2 et:
