---
- hosts: all

  vars:
    nbde_client_test_device: /tmp/.nbde_client_dev_test
    nbde_client_test_pass: test-password-here

    nbde_client_bindings:
      - devices:
          - path: "{{ nbde_client_test_device }}"
            pass: "{{ nbde_client_test_pass }}"
        auth:
          servers:
            - public.nbde.cc

  tasks:
    - name: Set up test device
      include: tasks/create_dummy_device.yml

    - name: Use nbde_client role
      include_role:
        name: linux-system-roles.nbde_client

    - name: Attempt to unlock device
      include: tasks/verify_unlock_device.yml

    - name: Make sure the attempt to unlock succeeded
      assert:
        that:
          - not nbde_unlock.failed
          - not nbde_close.failed

    - name: Clean up
      include: tasks/cleanup_dummy_device.yml
# vim:set ts=2 sw=2 et:
