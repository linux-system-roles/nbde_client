---
- hosts: all

  vars:
    test_device: /tmp/.nbde_client_dev_test
    test_pass: test-password-here
    test_keyfile: /tmp/.nbde_client_dev_keyfile

    nbde_client_bindings:
      - devices:
          - path: "{{ test_device }}"
            keyfile: "{{ test_keyfile }}"
        pin:
          discard_passphrase: yes
          servers:
            - public.nbde.cc
      - devices:
          - path: "{{ test_device }}"
        pin:
          overwrite: yes
          servers:
            - public.nbde.cc

  tasks:
    - name: Set up test device
      include: create_dummy_device.yml

    - name: Use nbde_client role
      include_role:
        name: linux-system-roles.nbde_client

    - name: Attempt to unlock device
      include: verify_unlock_device.yml

    - name: Make sure the attempt to unlock succeeded
      assert:
        that:
          - not nbde_unlock.failed
          - not nbde_close.failed

    - name: Attempt to check whether default keyfile works
      include: verify_default_keyfile.yml

    - name: Make sure the default keyfile did not work
      assert:
        that:
          - nbde_keyfile.rc != 0

    - name: Clean up
      include: cleanup_dummy_device.yml
# vim:set ts=2 sw=2 et:
