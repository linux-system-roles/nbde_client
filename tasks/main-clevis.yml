---
- name: Ensure required packages are installed
  package:
    name: "{{ __nbde_client_packages }}"
    state: present


- name: Prepare key files, perform clevis operations and dispose of key files
  block:
    - name: Ensure we transfer key files
      copy:
        src: "{{ item.key_file }}"
        dest: "{{ __nbde_client_managed_dir }}/"
        mode: '0400'
      when:
        - item.key_file | default("")
      loop: "{{ nbde_client_bindings }}"
      loop_control:
        label: "{{ item.key_file | default('') }}"

    - name: Perform clevis operations
      when: nbde_client_bindings | default([])
      nbde_client_clevis:
        bindings: "{{ nbde_client_bindings | default([]) }}"
        data_dir: "{{ __nbde_client_managed_dir }}"
      notify: nbde_client update initramfs

  always:
    - name: Ensure we dispose of any transferred key files
      file:
        path: "{{ __nbde_client_managed_dir }}/{{ item.key_file | basename }}"
        state: absent
      when:
        - item.key_file | default("")
      loop: "{{ nbde_client_bindings }}"
      loop_control:
        label: "{{ item.key_file | default('') }}"

# vim:set ts=2 sw=2 et:
